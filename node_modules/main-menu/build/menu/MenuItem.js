'use strict';

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ('value' in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

var _get = function get(_x, _x2, _x3) { var _again = true; _function: while (_again) { var object = _x, property = _x2, receiver = _x3; _again = false; if (object === null) object = Function.prototype; var desc = Object.getOwnPropertyDescriptor(object, property); if (desc === undefined) { var parent = Object.getPrototypeOf(object); if (parent === null) { return undefined; } else { _x = parent; _x2 = property; _x3 = receiver; _again = true; desc = parent = undefined; continue _function; } } else if ('value' in desc) { return desc.value; } else { var getter = desc.get; if (getter === undefined) { return undefined; } return getter.call(receiver); } } };

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError('Cannot call a class as a function'); } }

function _inherits(subClass, superClass) { if (typeof superClass !== 'function' && superClass !== null) { throw new TypeError('Super expression must either be null or a function, not ' + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

var _underscore = require('underscore');

var _underscore2 = _interopRequireDefault(_underscore);

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _reactDom = require('react-dom');

var _reactDom2 = _interopRequireDefault(_reactDom);

var _reactEs6Component = require('react-es6-component');

var _reactEs6Component2 = _interopRequireDefault(_reactEs6Component);

var _mousetrap = require('mousetrap');

var _mousetrap2 = _interopRequireDefault(_mousetrap);

var MenuItem = (function (_Component) {
  _inherits(MenuItem, _Component);

  _createClass(MenuItem, null, [{
    key: 'propTypes',
    value: {
      label: _react2['default'].PropTypes.string,
      separator: _react2['default'].PropTypes.bool,
      shortcut: _react2['default'].PropTypes.string,
      onClose: _react2['default'].PropTypes.func,
      onClick: _react2['default'].PropTypes.func
    },
    enumerable: true
  }, {
    key: 'defaultProps',
    value: {
      onClose: function onClose() {},
      onClick: function onClick() {}
    },
    enumerable: true
  }]);

  function MenuItem() {
    var _this = this;

    _classCallCheck(this, MenuItem);

    _get(Object.getPrototypeOf(MenuItem.prototype), 'constructor', this).apply(this, arguments);
    this.state = {
      open: false
    };
    this._isOpen = false;
    if (this.props.shortcut) {
      _mousetrap2['default'].bind(this.props.shortcut.toLowerCase(), function () {
        _this.props.onClick();
      });
    }
  }

  _createClass(MenuItem, [{
    key: 'render',
    value: function render() {
      if (this.props.separator) {
        return _react2['default'].createElement(
          'div',
          { className: 'menu-item-separator' },
          _react2['default'].createElement('div', { className: 'sep' })
        );
      } else {
        var className = "menu-item";
        if (this.state.open) {
          className += " open";
        }
        return _react2['default'].createElement(
          'div',
          _extends({ onMouseEnter: this._onMouseEnter,
            onMouseLeave: this._onMouseLeave,
            onClickCapture: this._onMenuClick,
            className: className }, this.props),
          _react2['default'].createElement(
            'div',
            { className: 'icon' },
            this._renderIcon()
          ),
          _react2['default'].createElement(
            'span',
            { className: 'menu-title' },
            this.props.label
          ),
          _react2['default'].createElement(
            'span',
            { className: 'menu-shortcut' },
            this.props.shortcut
          ),
          this._renderExpanderArrow(),
          this._renderChildren()
        );
      }
    }
  }, {
    key: 'componentDidMount',
    value: function componentDidMount() {
      this._addListeners();
    }
  }, {
    key: 'componentWillUnmount',
    value: function componentWillUnmount() {
      this._removeListeners();
    }
  }, {
    key: 'isOpen',
    value: function isOpen() {
      return this._isOpen;
    }
  }, {
    key: 'open',
    value: function open() {
      this._isOpen = true;
      this.setState({
        open: true
      });
    }
  }, {
    key: 'close',
    value: function close() {
      this._isOpen = false;
      this.setState({
        open: false
      });
    }
  }, {
    key: '_renderIcon',
    value: function _renderIcon() {
      if (this.props.icon) {
        return _react2['default'].createElement('img', { src: this.props.icon });
      }
    }
  }, {
    key: '_renderExpanderArrow',
    value: function _renderExpanderArrow() {
      if (this.props.children) {
        return _react2['default'].createElement('div', { className: 'arrow-right' });
      }
    }
  }, {
    key: '_renderChildren',
    value: function _renderChildren() {
      var _this2 = this;

      if (this.props.children) {
        var children = _react2['default'].Children.map(this.props.children, function (element) {
          return _react2['default'].cloneElement(element, { onClose: _this2._onCloseChild });
        });
        return _react2['default'].createElement(
          'div',
          { className: 'menu-children' },
          children
        );
      }
    }
  }, {
    key: '_onMouseEnter',
    value: function _onMouseEnter() {
      var _this3 = this;

      clearTimeout(this._menuCloseTimeout);
      this._menuItemTimeout = setTimeout(function () {
        _this3._hoverClick = true;
        _this3._isOpen = true;
        _this3.setState({
          open: true
        });
      }, 500);
    }
  }, {
    key: '_onMouseLeave',
    value: function _onMouseLeave(event) {
      var _this4 = this;

      clearTimeout(this._menuItemTimeout);
      this._menuCloseTimeout = setTimeout(function () {
        if (_this4._hoverClick) {
          _this4._hoverClick = false;
          _this4._isOpen = false;
          _this4.setState({
            open: false
          });
        }
      }, 200);
    }
  }, {
    key: '_onMenuClick',
    value: function _onMenuClick(event) {

      this._hoverClick = false;
      clearTimeout(this._menuItemTimeout);
      if (this._isLeaf()) {
        event.preventDefault();
        event.stopPropagation();
        this._isOpen = false;
        this.setState({
          open: false
        });
        this.props.onClick();
        if (this.props.onClose) {
          this.props.onClose();
        }
      } else {
        if (!this.state.open) {
          event.preventDefault();
          event.stopPropagation();
          this._isOpen = true;
          this.setState({
            open: true
          });
        }
      }
    }
  }, {
    key: '_addListeners',
    value: function _addListeners() {
      document.addEventListener('click', this._onDocumentClick);
    }
  }, {
    key: '_removeListeners',
    value: function _removeListeners() {
      document.removeEventListener('click', this._onDocumentClick);
    }
  }, {
    key: '_onDocumentClick',
    value: function _onDocumentClick(event) {
      if (this.state.open && !_reactDom2['default'].findDOMNode(this).contains(event.target)) {
        this._isOpen = false;
        this.setState({
          open: false
        });
      }
    }
  }, {
    key: '_isLeaf',
    value: function _isLeaf() {
      return !this.props.children || this.props.children.length === 0;
    }
  }, {
    key: '_onCloseChild',
    value: function _onCloseChild() {
      this._isOpen = false;
      this.setState({
        open: false
      });
      this.props.onClose();
    }
  }]);

  return MenuItem;
})(_reactEs6Component2['default']);

exports['default'] = MenuItem;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,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QUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0tBQzNEOzs7V0FFZSw0QkFBRTtBQUNoQixjQUFRLENBQUMsbUJBQW1CLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0tBQzlEOzs7V0FFZSwwQkFBQyxLQUFLLEVBQUM7QUFDckIsVUFBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksSUFBSSxDQUFDLHNCQUFTLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxFQUFDO0FBQ3ZFLFlBQUksQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDO0FBQ3JCLFlBQUksQ0FBQyxRQUFRLENBQUM7QUFDWixjQUFJLEVBQUUsS0FBSztTQUNaLENBQUMsQ0FBQztPQUNKO0tBQ0Y7OztXQUVNLG1CQUFFO0FBQ1AsYUFBTyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUM7S0FDakU7OztXQUVZLHlCQUFFO0FBQ2IsVUFBSSxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUM7QUFDckIsVUFBSSxDQUFDLFFBQVEsQ0FBQztBQUNaLFlBQUksRUFBRSxLQUFLO09BQ1osQ0FBQyxDQUFDO0FBQ0gsVUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQztLQUN0Qjs7O1NBOUxrQixRQUFROzs7cUJBQVIsUUFBUSIsImZpbGUiOiJtZW51L01lbnVJdGVtLmpzeCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ3VuZGVyc2NvcmUnO1xuaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCBSZWFjdERPTSBmcm9tICdyZWFjdC1kb20nO1xuaW1wb3J0IENvbXBvbmVudCBmcm9tICdyZWFjdC1lczYtY29tcG9uZW50JztcbmltcG9ydCBNb3VzZXRyYXAgZnJvbSAnbW91c2V0cmFwJztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgTWVudUl0ZW0gZXh0ZW5kcyBDb21wb25lbnQge1xuICBzdGF0aWMgcHJvcFR5cGVzID0ge1xuICAgIGxhYmVsOiBSZWFjdC5Qcm9wVHlwZXMuc3RyaW5nLFxuICAgIHNlcGFyYXRvcjogUmVhY3QuUHJvcFR5cGVzLmJvb2wsXG4gICAgc2hvcnRjdXQ6IFJlYWN0LlByb3BUeXBlcy5zdHJpbmcsXG4gICAgb25DbG9zZTogUmVhY3QuUHJvcFR5cGVzLmZ1bmMsXG4gICAgb25DbGljazogUmVhY3QuUHJvcFR5cGVzLmZ1bmNcbiAgfVxuXG4gIHN0YXRpYyBkZWZhdWx0UHJvcHMgPSB7XG4gICAgb25DbG9zZTogZnVuY3Rpb24oKXt9LFxuICAgIG9uQ2xpY2s6IGZ1bmN0aW9uKCl7fVxuICB9XG5cbiAgc3RhdGUgPSB7XG4gICAgb3BlbjogZmFsc2VcbiAgfVxuXG4gIF9pc09wZW4gPSBmYWxzZTtcblxuICBjb25zdHJ1Y3Rvcigpe1xuICAgIHN1cGVyKC4uLmFyZ3VtZW50cyk7XG4gICAgaWYodGhpcy5wcm9wcy5zaG9ydGN1dCl7XG4gICAgICBNb3VzZXRyYXAuYmluZCh0aGlzLnByb3BzLnNob3J0Y3V0LnRvTG93ZXJDYXNlKCksICgpID0+IHtcbiAgICAgICAgdGhpcy5wcm9wcy5vbkNsaWNrKCk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICByZW5kZXIoKXtcbiAgICBpZih0aGlzLnByb3BzLnNlcGFyYXRvcil7XG4gICAgICByZXR1cm4gKFxuICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm1lbnUtaXRlbS1zZXBhcmF0b3JcIj5cbiAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cInNlcFwiPjwvZGl2PlxuICAgICAgICA8L2Rpdj5cbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxldCBjbGFzc05hbWUgPSBcIm1lbnUtaXRlbVwiO1xuICAgICAgaWYodGhpcy5zdGF0ZS5vcGVuKXtcbiAgICAgICAgY2xhc3NOYW1lICs9IFwiIG9wZW5cIjtcbiAgICAgIH1cbiAgICAgIHJldHVybiAoXG4gICAgICAgIDxkaXYgb25Nb3VzZUVudGVyPXt0aGlzLl9vbk1vdXNlRW50ZXJ9XG4gICAgICAgICAgICAgb25Nb3VzZUxlYXZlPXt0aGlzLl9vbk1vdXNlTGVhdmV9XG4gICAgICAgICAgICAgb25DbGlja0NhcHR1cmU9e3RoaXMuX29uTWVudUNsaWNrfVxuICAgICAgICAgICAgIGNsYXNzTmFtZT17Y2xhc3NOYW1lfSB7Li4udGhpcy5wcm9wc30+XG4gICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJpY29uXCI+XG4gICAgICAgICAgICB7dGhpcy5fcmVuZGVySWNvbigpfVxuICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgIDxzcGFuIGNsYXNzTmFtZT1cIm1lbnUtdGl0bGVcIiA+e3RoaXMucHJvcHMubGFiZWx9PC9zcGFuPlxuICAgICAgICAgIDxzcGFuIGNsYXNzTmFtZT1cIm1lbnUtc2hvcnRjdXRcIj57dGhpcy5wcm9wcy5zaG9ydGN1dH08L3NwYW4+XG4gICAgICAgICAge3RoaXMuX3JlbmRlckV4cGFuZGVyQXJyb3coKX1cbiAgICAgICAgICB7dGhpcy5fcmVuZGVyQ2hpbGRyZW4oKX1cbiAgICAgICAgPC9kaXY+XG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIGNvbXBvbmVudERpZE1vdW50KCl7XG4gICAgdGhpcy5fYWRkTGlzdGVuZXJzKCk7XG4gIH1cblxuICBjb21wb25lbnRXaWxsVW5tb3VudCgpe1xuICAgIHRoaXMuX3JlbW92ZUxpc3RlbmVycygpO1xuICB9XG5cbiAgaXNPcGVuKCl7XG4gICAgcmV0dXJuIHRoaXMuX2lzT3BlbjtcbiAgfVxuXG4gIG9wZW4oKXtcbiAgICB0aGlzLl9pc09wZW4gPSB0cnVlO1xuICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgb3BlbjogdHJ1ZVxuICAgIH0pO1xuICB9XG5cbiAgY2xvc2UoKXtcbiAgICB0aGlzLl9pc09wZW4gPSBmYWxzZTtcbiAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgIG9wZW46IGZhbHNlXG4gICAgfSk7XG4gIH1cblxuICBfcmVuZGVySWNvbigpe1xuICAgIGlmKHRoaXMucHJvcHMuaWNvbil7XG4gICAgICByZXR1cm4gPGltZyBzcmM9e3RoaXMucHJvcHMuaWNvbn0+PC9pbWc+XG4gICAgfVxuICB9XG5cbiAgX3JlbmRlckV4cGFuZGVyQXJyb3coKXtcbiAgICBpZih0aGlzLnByb3BzLmNoaWxkcmVuKXtcbiAgICAgIHJldHVybiAoXG4gICAgICAgIDxkaXYgY2xhc3NOYW1lPVwiYXJyb3ctcmlnaHRcIj5cbiAgICAgICAgPC9kaXY+XG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIF9yZW5kZXJDaGlsZHJlbigpe1xuICAgIGlmKHRoaXMucHJvcHMuY2hpbGRyZW4pe1xuICAgICAgY29uc3QgY2hpbGRyZW4gPSBSZWFjdC5DaGlsZHJlbi5tYXAodGhpcy5wcm9wcy5jaGlsZHJlbiwgKGVsZW1lbnQpID0+IHtcbiAgICAgICAgcmV0dXJuIFJlYWN0LmNsb25lRWxlbWVudChlbGVtZW50LCB7b25DbG9zZTogdGhpcy5fb25DbG9zZUNoaWxkfSk7XG4gICAgICB9KTtcbiAgICAgIHJldHVybiAoXG4gICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibWVudS1jaGlsZHJlblwiPlxuICAgICAgICAgIHtjaGlsZHJlbn1cbiAgICAgICAgPC9kaXY+XG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIF9vbk1vdXNlRW50ZXIoKXtcbiAgICBjbGVhclRpbWVvdXQodGhpcy5fbWVudUNsb3NlVGltZW91dCk7XG4gICAgdGhpcy5fbWVudUl0ZW1UaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICB0aGlzLl9ob3ZlckNsaWNrID0gdHJ1ZTtcbiAgICAgIHRoaXMuX2lzT3BlbiA9IHRydWU7XG4gICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgb3BlbjogdHJ1ZVxuICAgICAgfSk7XG4gICAgfSwgNTAwKTtcbiAgfVxuXG4gIF9vbk1vdXNlTGVhdmUoZXZlbnQpe1xuICAgIGNsZWFyVGltZW91dCh0aGlzLl9tZW51SXRlbVRpbWVvdXQpO1xuICAgIHRoaXMuX21lbnVDbG9zZVRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIGlmKHRoaXMuX2hvdmVyQ2xpY2spe1xuICAgICAgICB0aGlzLl9ob3ZlckNsaWNrID0gZmFsc2U7XG4gICAgICAgIHRoaXMuX2lzT3BlbiA9IGZhbHNlO1xuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICBvcGVuOiBmYWxzZVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9LCAyMDApO1xuICB9XG5cbiAgX29uTWVudUNsaWNrKGV2ZW50KXtcblxuICAgIHRoaXMuX2hvdmVyQ2xpY2sgPSBmYWxzZTtcbiAgICBjbGVhclRpbWVvdXQodGhpcy5fbWVudUl0ZW1UaW1lb3V0KTtcbiAgICBpZih0aGlzLl9pc0xlYWYoKSl7XG4gICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICB0aGlzLl9pc09wZW4gPSBmYWxzZTtcbiAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICBvcGVuOiBmYWxzZVxuICAgICAgfSk7XG4gICAgICB0aGlzLnByb3BzLm9uQ2xpY2soKTtcbiAgICAgIGlmKHRoaXMucHJvcHMub25DbG9zZSl7XG4gICAgICAgIHRoaXMucHJvcHMub25DbG9zZSgpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBpZighdGhpcy5zdGF0ZS5vcGVuKXtcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIHRoaXMuX2lzT3BlbiA9IHRydWU7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgIG9wZW46IHRydWVcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgX2FkZExpc3RlbmVycygpe1xuICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgdGhpcy5fb25Eb2N1bWVudENsaWNrKTtcbiAgfVxuXG4gIF9yZW1vdmVMaXN0ZW5lcnMoKXtcbiAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdjbGljaycsIHRoaXMuX29uRG9jdW1lbnRDbGljayk7XG4gIH1cblxuICBfb25Eb2N1bWVudENsaWNrKGV2ZW50KXtcbiAgICBpZih0aGlzLnN0YXRlLm9wZW4gJiYgIVJlYWN0RE9NLmZpbmRET01Ob2RlKHRoaXMpLmNvbnRhaW5zKGV2ZW50LnRhcmdldCkpe1xuICAgICAgdGhpcy5faXNPcGVuID0gZmFsc2U7XG4gICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgb3BlbjogZmFsc2VcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIF9pc0xlYWYoKXtcbiAgICByZXR1cm4gIXRoaXMucHJvcHMuY2hpbGRyZW4gfHwgdGhpcy5wcm9wcy5jaGlsZHJlbi5sZW5ndGggPT09IDA7XG4gIH1cblxuICBfb25DbG9zZUNoaWxkKCl7XG4gICAgdGhpcy5faXNPcGVuID0gZmFsc2U7XG4gICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICBvcGVuOiBmYWxzZVxuICAgIH0pO1xuICAgIHRoaXMucHJvcHMub25DbG9zZSgpO1xuICB9XG59XG4iXX0=